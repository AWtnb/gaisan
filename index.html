<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20style%3D%22dominant-baseline%3Acentral%3Btext-anchor%3Amiddle%3Bfont-size%3A90px%3B%22%3E%26%23x1F9EA%3B%3C/text%3E%3C/svg%3E">
    <title>GAI-SAN</title>
    <link rel="stylesheet" type="text/css" href="./almond.lite.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

        :root {
            --border: #004d61;
            --bg: #e5e2df;
            --bg-light: #f5f5f5;
        }

        html {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            background-color: var(--bg);
        }

        body {
            color: #333;
            margin-bottom: 25vh;
            max-width: 800px;
            min-width: 660px;
        }

        textarea {
            display: block;
            width: 90%;
            min-height: 400px;
            margin: 0 auto;
            box-shadow: 1px 1px 5px 1px #aaa;
        }
        input {
            box-shadow: 1px 1px 5px 1px #aaa;
            width: 100px;
        }

        table {
            width: 90%;
            margin: 0 auto;
        }
        table thead {
            background-color: var(--bg-light);
        }
        table thead tr {
            border-bottom: 1px solid var(--border);
        }
        table tbody tr {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }
        td:nth-child(2), td:nth-child(2) *,
        th:nth-child(2) {
            color: #aaa;
        }

        .ui {
            display: flex;
            width: 90%;
            margin: 0 auto;
            justify-content: space-between;
        }
        .ui .box {
            margin: 1rem auto;
        }
        .paren {
            font-size: .9em;
        }
        .repo {
            margin: 2rem;
            text-align: center;
        }
        .repo a {
            text-decoration: none;
        }

</style>
</head>

<body>
    <div id="app">
        <textarea placeholder="paste here!" v-model="content"></textarea>
        <div class="ui">
            <div class="box">
                <div>字詰め</div>
                <input type="number" min="1" v-model="charsPerLine">
            </div>
            <div class="box">
                <div>行取り</div>
                <input type="number" min="1" v-model="linesPerPage">
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>概算</th>
                    <th>空白除外</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {{totalChars.gross}}
                        文字
                    </td>
                    <td>
                        {{totalChars.net}}
                        文字
                    </td>
                </tr>
                <tr>
                    <td>
                        {{totalLines.gross}}
                        行
                    </td>
                    <td>
                        {{totalLines.net}}
                        行
                    </td>
                </tr>
                <tr>
                    <td>
                        <page-count :page="totalPages.gross"></page-count>
                    </td>
                    <td>
                        <page-count :page="totalPages.net"></page-count>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="repo"><a href="https://github.com/AWtnb/gaisan" target="_blank">github</a></div>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
    <script>

        // https://zukucode.com/2017/04/javascript-string-length.html
        String.prototype.bytes = function () {
            let sum = 0;
            for (let i = 0; i < this.length; i++) {
                const c = this.charCodeAt(i);
                if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c < 0xffa0) || (c >= 0xf8f1 && c < 0xf8f4)) {
                    sum += 1;
                } else {
                    sum += 2;
                }
            }
            return sum;
        };

        const pageCount = {
            props: {
                page: {
                    type: Object,
                    require: true
                }
            },
            template: `
            {{page.small}}
            ページ
            <span class="paren">
            &#65288;
            <span>&times;1.1 = {{page.middle}}</span>
            ,
            <span>&times;1.2 = {{page.large}}</span>
            &#65289;
            </span>
            `
        };

        const countChars = (lines) => {
            return lines.reduce((accum, cur) => accum + cur.length, 0);
        }

        const countLines = (lines, charsPerLine) => {
            if (charsPerLine < 1) {
                return 0;
            }
            return lines.reduce((accum, cur) => {
                const nBox = Math.ceil(cur.bytes() / 2);
                const lines = Math.ceil(nBox / charsPerLine);
                return accum + lines;
            }, 0);
        }

        const vm = Vue.createApp({
            data: function () {
                return {
                    content: "",
                    charsPerLine: 35,
                    linesPerPage: 30,
                }
            },
            computed: {
                contentLines: function () {
                    return this.content.split(/\n/).filter(line => String(line).trim().length > 0);
                },
                pureLines: function () {
                    return this.contentLines.map(line => line.trim().replace(/\s+/g, ""));
                },
                totalChars: function () {
                    return {
                        gross: countChars(this.contentLines),
                        net: countChars(this.pureLines)
                    }
                },
                totalLines: function () {
                    return {
                        gross: countLines(this.contentLines, this.charsPerLine),
                        net: countLines(this.pureLines, this.charsPerLine)
                    }
                },
                totalPages: function () {
                    const gross = (this.linesPerPage < 1)? 0 : Math.ceil(this.totalLines.gross / this.linesPerPage);
                    const net = (this.linesPerPage < 1)? 0 : Math.ceil(this.totalLines.net / this.linesPerPage);
                    return {
                        gross: {
                            small: gross,
                            middle: Math.ceil(gross * 1.1),
                            large: Math.ceil(gross * 1.2),
                        },
                        net: {
                            small: net,
                            middle: Math.ceil(net * 1.1),
                            large: Math.ceil(net * 1.2),
                        },
                    }
                },
            },
            components: {
                "page-count": pageCount
            }
        }).mount("#app");
    </script>
</body>

</html>